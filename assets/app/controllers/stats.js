'use strict';

/* global angular, moment */

angular.module('DojoApp.controllers')
    .controller('StatsController', ['$scope', '$http', '$routeParams', '$resource', '$q', '$filter', '$window', 'spinnerService', '$modal', 'messageBus', function(
                                     $scope,   $http,   $routeParams,   $resource,   $q,   $filter,   $window,   spinnerService,   $modal,   messageBus) {

        // -------------------------------------------
        // Scope Variables
        // -------------------------------------------

        // params
        $scope.country = $routeParams.country || 'usa';
        $scope.state   = $routeParams.state   || '';
        $scope.city    = ($routeParams.state) ? $routeParams.city.toString().replace('-', ' ') : '';
        $scope.graphs  = {};

        // property types values
        $scope.propertyTypes = [
            {ID: 'Single-Family', Title: 'Single-Family'},
            {ID: 'Townhouse',     Title: 'Townhouse'},
            {ID: 'Condo',         Title: 'Condo'},
            {ID: 'All',           Title: 'All'}
        ];
        $scope.inputPropertyType = $scope.propertyTypes[0].ID; // default property type
        $scope.tableSettings = {
            "bAutoWidth" : false,
            "useFloater" : false,
            "sDom"       : 'T<"clear">lfrtip',
            "oTableTools": {
                "sRowSelect": "single"
            }
        };
        $scope.scope = $scope;

        // -------------------------------------------
        // Private
        // -------------------------------------------

        var tableLookFields = {
            'average_sales_price': function(value) {
                return $filter('currency')(value, '$');
            },
            'sold_price_per_sqft': function(value) {
                return $filter('currency')(value, '$');
            },
            'total_sold'         : function(value) {
                return value;
            },
            'total_new'          : function(value) {
                return value;
            },
            'total_pending'      : function(value) {
                return value;
            },
            'inventory'          : function(value) {
                return value;
            },
            'average_dom'        : function(value) {
                return value;
            }
        };

        function buildGraphs(data) {
            $scope.graphData = data;

            // generate the table data
            $scope.tableData = {};
            angular.forEach(tableLookFields, function(itemX, keyX) {
                angular.forEach($scope.graphData.payload[keyX], function(item, key) {
                    $scope.tableData[keyX] = $scope.tableData[keyX] || [];
                    $scope.tableData[keyX].push({
                        'date' : key,
                        'value': itemX(item)
                    });
                });
            });

            /*
             angular.forEach($scope.graphData.payload['sold_price_per_sqft'], function(item, key) {
             if (! $scope.tableData.sold_price_per_sqft) {
             $scope.tableData.sold_price_per_sqft = [];
             }

             $scope.tableData.sold_price_per_sqft.push({
             'date': key,
             'value': $filter('currency')(item, '$')
             });
             });
             */

            // calculate number of sold property
            $scope.totalSold = 0;
            angular.forEach($scope.graphData.payload.total_sold, function(item, key) {
                if (_.isNumber(item)) {
                    $scope.totalSold += parseInt(item);
                }
            });

            // total new
            $scope.totalNew = 0;
            angular.forEach($scope.graphData.payload.total_new, function(item, key) {
                $scope.totalNew += parseInt(item);
            });

            // pending
            $scope.totalPending = 0;
            angular.forEach($scope.graphData.payload.total_pending, function(item, key) {
                $scope.totalPending += parseInt(item);
            });

            // total inventory
            $scope.totalInventory = 0;
            angular.forEach($scope.graphData.payload.inventory, function(item, key) {
                $scope.totalInventory += parseInt(item);
            });

            // average property sales / day
            var totalDays = (moment($scope.inputReportDate.to).diff(moment($scope.inputReportDate.from), 'days'));
            $scope.totalSoldPerDay = ! parseFloat(totalDays) === 0 ? parseFloat($scope.totalSold / totalDays).toFixed(2) : 0;

            // average days on market
            $scope.totalDom = 0;
            var count = 0;
            angular.forEach($scope.graphData.payload.average_dom, function(item, key) {
                count ++;
                $scope.totalDom += parseInt(item);
            });
            $scope.averageDom = parseFloat($scope.totalDom / count).toFixed(2);

            // total went pending this month
            var keysPending = _.keys($scope.graphData.payload.total_pending);

            $scope.thisMonthTotalPending = $scope.graphData.payload.total_pending[keysPending[keysPending.length - 1]];
            $scope.mostExpensiveProperty = (data.payload.most_expensive && data.payload.most_expensive[0]) ? data.payload.most_expensive[0] : null;
            $scope.mostCheapestProperty = (data.payload.most_cheapest && data.payload.most_cheapest[0]) ? data.payload.most_cheapest[0] : null;
            $scope.marketType = data.payload.market_type;
        }

        // generate the data
        function getData() {

            var Stats = $resource('/stats/city');

            // default daterange settings is past two years
            if(! $scope.inputReportDate) {
                $scope.inputReportDate = {};
                $scope.inputReportDate.from = moment().subtract('years', 2).startOf('year').format('L');
                $scope.inputReportDate.to = moment().format('L');
            }

            // calculate months difference
            $scope.dateRangeMonthsDiff = moment($scope.inputReportDate.to).diff(moment($scope.inputReportDate.from), 'month');

            // temporary
//            var results =  angular.fromJson('[{"status":"success","payload":{"average_sales_price":{"2012-1":"524181.04","2012-2":"509085.60","2012-3":"547653.37","2012-4":"524443.75","2012-5":"585025.25","2012-6":"606347.76","2012-7":"608237.15","2012-8":"582665.81","2012-9":"610847.26","2012-10":"651509.47","2012-11":"622331.42","2012-12":"603112.27","2013-1":"657438.35","2013-2":"701976.55","2013-3":"787498.21","2013-4":"872785.00","2013-5":"821530.57","2013-6":"688733.34","2013-7":"664808.05","2013-8":"661712.49","2013-9":"686381.84","2013-10":"666626.59","2013-11":"663363.97","2013-12":"690150.00","2014-1":"818635.47","2014-2":"904097.51","2014-3":"884054.63","2014-4":"885547.00","2014-5":"942369.55","2014-6":"946735.68","2014-7":"950928.62","2014-8":"904944.21"},"average_sales_price_percentage_difference":{"2012-2":"-2.88","2012-3":"7.58","2012-4":"-4.24","2012-5":"11.55","2012-6":"3.64","2012-7":"0.31","2012-8":"-4.20","2012-9":"4.84","2012-10":"6.66","2012-11":"-4.48","2012-12":"-3.09","2013-1":"9.01","2013-2":"6.77","2013-3":"12.18","2013-4":"10.83","2013-5":"-5.87","2013-6":"-16.16","2013-7":"-3.47","2013-8":"-0.47","2013-9":"3.73","2013-10":"-2.88","2013-11":"-0.49","2013-12":"4.04","2014-1":"18.62","2014-2":"10.44","2014-3":"-2.22","2014-4":"0.17","2014-5":"6.42","2014-6":"0.46","2014-7":"0.44","2014-8":0},"average_sales_price_percentage_difference_first_last":"72.64","average_sales_price_trend_line":{"2012-1":512043.5702840912,"2012-2":524927.3677254402,"2012-3":537811.1651667892,"2012-4":550694.9626081381,"2012-5":563578.760049487,"2012-6":576462.557490836,"2012-7":589346.354932185,"2012-8":602230.1523735339,"2012-9":615113.9498148828,"2012-10":627997.7472562318,"2012-11":640881.5446975809,"2012-12":653765.3421389298,"2013-1":666649.1395802787,"2013-2":679532.9370216277,"2013-3":692416.7344629767,"2013-4":705300.5319043256,"2013-5":718184.3293456745,"2013-6":731068.1267870235,"2013-7":743951.9242283725,"2013-8":756835.7216697214,"2013-9":769719.5191110703,"2013-10":782603.3165524193,"2013-11":795487.1139937683,"2013-12":808370.9114351172,"2014-1":821254.7088764661,"2014-2":834138.5063178152,"2014-3":847022.3037591642,"2014-4":859906.1012005131,"2014-5":872789.898641862,"2014-6":885673.696083211,"2014-7":898557.49352456,"2014-8":911441.2909659089},"average_dom":{"2012-1":"48.17","2012-2":"34.27","2012-3":"38.77","2012-4":"33.04","2012-5":"28.49","2012-6":"26.17","2012-7":"23.64","2012-8":"22.54","2012-9":"21.67","2012-10":"27.45","2012-11":"26.96","2012-12":"30.35","2013-1":"23.57","2013-2":"18.62","2013-3":"13.69","2013-4":"19.71","2013-5":"15.21","2013-6":"13.05","2013-7":"13.65","2013-8":"14.67","2013-9":"18.12","2013-10":"21.34","2013-11":"22.97","2013-12":"30.96","2014-1":"38.33","2014-2":"18.05","2014-3":"14.23","2014-4":"15.95","2014-5":"12.94","2014-6":"17.57","2014-7":"24.47","2014-8":"15.51"},"average_dom_percentage_difference":{"2012-2":"-28.86","2012-3":"13.13","2012-4":"-14.78","2012-5":"-13.77","2012-6":"-8.14","2012-7":"-9.67","2012-8":"-4.65","2012-9":"-3.86","2012-10":"26.67","2012-11":"-1.79","2012-12":"12.57","2013-1":"-22.34","2013-2":"-21.00","2013-3":"-26.48","2013-4":"43.97","2013-5":"-22.83","2013-6":"-14.20","2013-7":"4.60","2013-8":"7.47","2013-9":"23.52","2013-10":"17.77","2013-11":"7.64","2013-12":"34.78","2014-1":"23.80","2014-2":"-52.91","2014-3":"-21.16","2014-4":"12.09","2014-5":"-18.87","2014-6":"35.78","2014-7":"39.27","2014-8":0},"average_dom_percentage_difference_first_last":"-67.80","average_dom_trend_line":{"2012-1":31.586022727272763,"2012-2":31.048476906158392,"2012-3":30.51093108504402,"2012-4":29.97338526392965,"2012-5":29.43583944281528,"2012-6":28.89829362170091,"2012-7":28.360747800586534,"2012-8":27.823201979472163,"2012-9":27.285656158357792,"2012-10":26.74811033724342,"2012-11":26.21056451612905,"2012-12":25.67301869501468,"2013-1":25.13547287390031,"2013-2":24.597927052785938,"2013-3":24.060381231671563,"2013-4":23.522835410557192,"2013-5":22.98528958944282,"2013-6":22.44774376832845,"2013-7":21.91019794721408,"2013-8":21.37265212609971,"2013-9":20.835106304985338,"2013-10":20.297560483870967,"2013-11":19.760014662756596,"2013-12":19.222468841642225,"2014-1":18.684923020527854,"2014-2":18.147377199413484,"2014-3":17.609831378299113,"2014-4":17.072285557184742,"2014-5":16.53473973607037,"2014-6":15.997193914955997,"2014-7":15.459648093841626,"2014-8":14.922102272727255},"total_sold":{"2012-1":"70","2012-2":"73","2012-3":"120","2012-4":"119","2012-5":"158","2012-6":"136","2012-7":"107","2012-8":"144","2012-9":"125","2012-10":"116","2012-11":"113","2012-12":"82","2013-1":"69","2013-2":"73","2013-3":"97","2013-4":"106","2013-5":"129","2013-6":"107","2013-7":"106","2013-8":"124","2013-9":"102","2013-10":"114","2013-11":"86","2013-12":"24","2014-1":"36","2014-2":"65","2014-3":"88","2014-4":"120","2014-5":"142","2014-6":"136","2014-7":"146","2014-8":"84"},"total_sold_percentage_difference":{"2012-2":"4.29","2012-3":"64.38","2012-4":"-0.83","2012-5":"32.77","2012-6":"-13.92","2012-7":"-21.32","2012-8":"34.58","2012-9":"-13.19","2012-10":"-7.20","2012-11":"-2.59","2012-12":"-27.43","2013-1":"-15.85","2013-2":"5.80","2013-3":"32.88","2013-4":"9.28","2013-5":"21.70","2013-6":"-17.05","2013-7":"-0.93","2013-8":"16.98","2013-9":"-17.74","2013-10":"11.76","2013-11":"-24.56","2013-12":"-72.09","2014-1":"50.00","2014-2":"80.56","2014-3":"35.38","2014-4":"36.36","2014-5":"18.33","2014-6":"-4.23","2014-7":"7.35","2014-8":0},"total_sold_percentage_difference_first_last":"20.00","total_sold_trend_line":{"2012-1":109.5340909090909,"2012-2":109.1548753665689,"2012-3":108.77565982404691,"2012-4":108.39644428152492,"2012-5":108.01722873900293,"2012-6":107.63801319648093,"2012-7":107.25879765395894,"2012-8":106.87958211143695,"2012-9":106.50036656891496,"2012-10":106.12115102639295,"2012-11":105.74193548387096,"2012-12":105.36271994134897,"2013-1":104.98350439882697,"2013-2":104.60428885630498,"2013-3":104.22507331378299,"2013-4":103.845857771261,"2013-5":103.46664222873899,"2013-6":103.087426686217,"2013-7":102.70821114369501,"2013-8":102.32899560117302,"2013-9":101.94978005865102,"2013-10":101.57056451612902,"2013-11":101.19134897360703,"2013-12":100.81213343108504,"2014-1":100.43291788856304,"2014-2":100.05370234604105,"2014-3":99.67448680351906,"2014-4":99.29527126099705,"2014-5":98.91605571847506,"2014-6":98.53684017595307,"2014-7":98.15762463343108,"2014-8":97.77840909090908},"sold_price_per_sqft":{"2012-1":"314.67","2012-2":"322.51","2012-3":"336.35","2012-4":"343.50","2012-5":"341.01","2012-6":"351.31","2012-7":"363.23","2012-8":"358.65","2012-9":"372.87","2012-10":"383.07","2012-11":"369.62","2012-12":"367.65","2013-1":"385.83","2013-2":"398.49","2013-3":"444.63","2013-4":"465.88","2013-5":"446.91","2013-6":"436.29","2013-7":"448.30","2013-8":"453.68","2013-9":"436.20","2013-10":"432.75","2013-11":"437.13","2013-12":"409.87","2014-1":"470.86","2014-2":"489.50","2014-3":"498.28","2014-4":"495.26","2014-5":"523.91","2014-6":"500.12","2014-7":"512.99","2014-8":"507.45"},"sold_price_per_sqft_percentage_difference":{"2012-2":"2.49","2012-3":"4.29","2012-4":"2.13","2012-5":"-0.72","2012-6":"3.02","2012-7":"3.39","2012-8":"-1.26","2012-9":"3.96","2012-10":"2.74","2012-11":"-3.51","2012-12":"-0.53","2013-1":"4.94","2013-2":"3.28","2013-3":"11.58","2013-4":"4.78","2013-5":"-4.07","2013-6":"-2.38","2013-7":"2.75","2013-8":"1.20","2013-9":"-3.85","2013-10":"-0.79","2013-11":"1.01","2013-12":"-6.24","2014-1":"14.88","2014-2":"3.96","2014-3":"1.79","2014-4":"-0.61","2014-5":"5.78","2014-6":"-4.54","2014-7":"2.57","2014-8":0},"sold_price_per_sqft_percentage_difference_first_last":"61.26","sold_price_per_sqft_trend_line":{"2012-1":320.97823863636387,"2012-2":327.32393695014684,"2012-3":333.6696352639298,"2012-4":340.0153335777128,"2012-5":346.3610318914958,"2012-6":352.7067302052788,"2012-7":359.0524285190618,"2012-8":365.39812683284475,"2012-9":371.7438251466277,"2012-10":378.0895234604107,"2012-11":384.4352217741937,"2012-12":390.78092008797665,"2013-1":397.12661840175963,"2013-2":403.47231671554266,"2013-3":409.81801502932564,"2013-4":416.1637133431086,"2013-5":422.5094116568916,"2013-6":428.85510997067456,"2013-7":435.20080828445754,"2013-8":441.5465065982405,"2013-9":447.89220491202354,"2013-10":454.23790322580646,"2013-11":460.5836015395895,"2013-12":466.9292998533724,"2014-1":473.27499816715545,"2014-2":479.6206964809384,"2014-3":485.9663947947214,"2014-4":492.31209310850437,"2014-5":498.65779142228735,"2014-6":505.0034897360704,"2014-7":511.3491880498533,"2014-8":517.6948863636363},"average_cdom":{"2012-1":"55.50","2012-2":"47.32","2012-3":"52.28","2012-4":"37.97","2012-5":"38.40","2012-6":"28.35","2012-7":"24.36","2012-8":"24.47","2012-9":"22.78","2012-10":"29.80","2012-11":"33.93","2012-12":"32.04","2013-1":"29.01","2013-2":"19.81","2013-3":"15.74","2013-4":"20.96","2013-5":"17.46","2013-6":"13.75","2013-7":"15.47","2013-8":"15.09","2013-9":"19.84","2013-10":"23.79","2013-11":"24.31","2013-12":"36.04","2014-1":"43.78","2014-2":"21.23","2014-3":"15.16","2014-4":"17.22","2014-5":"13.38","2014-6":"18.21","2014-7":"25.59","2014-8":"16.74"},"average_cdom_percentage_difference":{"2012-2":"-14.74","2012-3":"10.48","2012-4":"-27.37","2012-5":"1.13","2012-6":"-26.17","2012-7":"-14.07","2012-8":"0.45","2012-9":"-6.91","2012-10":"30.82","2012-11":"13.86","2012-12":"-5.57","2013-1":"-9.46","2013-2":"-31.71","2013-3":"-20.55","2013-4":"33.16","2013-5":"-16.70","2013-6":"-21.25","2013-7":"12.51","2013-8":"-2.46","2013-9":"31.48","2013-10":"19.91","2013-11":"2.19","2013-12":"48.25","2014-1":"21.48","2014-2":"-51.51","2014-3":"-28.59","2014-4":"13.59","2014-5":"-22.30","2014-6":"36.10","2014-7":"40.53","2014-8":0},"average_dom_mls":{"2012-1":"47.30","2012-2":"33.88","2012-3":"37.04","2012-4":"31.07","2012-5":"27.22","2012-6":"25.24","2012-7":"21.43","2012-8":"21.29","2012-9":"20.90","2012-10":"25.01","2012-11":"25.87","2012-12":"27.32","2013-1":"21.78","2013-2":"17.12","2013-3":"12.82","2013-4":"19.38","2013-5":"14.34","2013-6":"11.48","2013-7":"12.87","2013-8":"13.81","2013-9":"16.94","2013-10":"20.39","2013-11":"22.33","2013-12":"30.58","2014-1":"32.11","2014-2":"15.45","2014-3":"13.32","2014-4":"14.46","2014-5":"12.48","2014-6":"14.63","2014-7":"23.68","2014-8":"14.65"},"average_dom_mls_percentage_difference":{"2012-2":"-28.37","2012-3":"9.33","2012-4":"-16.12","2012-5":"-12.39","2012-6":"-7.27","2012-7":"-15.10","2012-8":"-0.65","2012-9":"-1.83","2012-10":"19.67","2012-11":"3.44","2012-12":"5.60","2013-1":"-20.28","2013-2":"-21.40","2013-3":"-25.12","2013-4":"51.17","2013-5":"-26.01","2013-6":"-19.94","2013-7":"12.11","2013-8":"7.30","2013-9":"22.66","2013-10":"20.37","2013-11":"9.51","2013-12":"36.95","2014-1":"5.00","2014-2":"-51.88","2014-3":"-13.79","2014-4":"8.56","2014-5":"-13.69","2014-6":"17.23","2014-7":"61.86","2014-8":0},"total_new":{"2012-1":"122","2012-2":"139","2012-3":"150","2012-4":"140","2012-5":"143","2012-6":"151","2012-7":"147","2012-8":"142","2012-9":"108","2012-10":"113","2012-11":"68","2012-12":"53","2013-1":"107","2013-2":"90","2013-3":"121","2013-4":"150","2013-5":"131","2013-6":"132","2013-7":"167","2013-8":"137","2013-9":"126","2013-10":"105","2013-11":"87","2013-12":"46","2014-1":"87","2014-2":"100","2014-3":"149","2014-4":"171","2014-5":"175","2014-6":"182","2014-7":"198","2014-8":"132"},"total_new_percentage_difference":{"2012-2":"13.93","2012-3":"7.91","2012-4":"-6.67","2012-5":"2.14","2012-6":"5.59","2012-7":"-2.65","2012-8":"-3.40","2012-9":"-23.94","2012-10":"4.63","2012-11":"-39.82","2012-12":"-22.06","2013-1":"101.89","2013-2":"-15.89","2013-3":"34.44","2013-4":"23.97","2013-5":"-12.67","2013-6":"0.76","2013-7":"26.52","2013-8":"-17.96","2013-9":"-8.03","2013-10":"-16.67","2013-11":"-17.14","2013-12":"-47.13","2014-1":"89.13","2014-2":"14.94","2014-3":"49.00","2014-4":"14.77","2014-5":"2.34","2014-6":"4.00","2014-7":"8.79","2014-8":0},"total_new_percentage_difference_first_last":"8.20","total_new_percentage_trend_line":{"result":{"2012-1":118.80681818181817,"2012-2":119.34549120234604,"2012-3":119.88416422287389,"2012-4":120.42283724340176,"2012-5":120.96151026392961,"2012-6":121.50018328445748,"2012-7":122.03885630498533,"2012-8":122.5775293255132,"2012-9":123.11620234604105,"2012-10":123.65487536656892,"2012-11":124.19354838709677,"2012-12":124.73222140762464,"2013-1":125.27089442815249,"2013-2":125.80956744868035,"2013-3":126.3482404692082,"2013-4":126.88691348973607,"2013-5":127.42558651026393,"2013-6":127.9642595307918,"2013-7":128.50293255131965,"2013-8":129.0416055718475,"2013-9":129.58027859237535,"2013-10":130.11895161290323,"2013-11":130.65762463343108,"2013-12":131.19629765395894,"2014-1":131.7349706744868,"2014-2":132.27364369501467,"2014-3":132.81231671554252,"2014-4":133.35098973607037,"2014-5":133.88966275659823,"2014-6":134.4283357771261,"2014-7":134.96700879765396,"2014-8":135.5056818181818}},"total_pending":{"2012-2":"0","2012-3":"0","2012-4":"0","2012-5":"0","2012-6":"0","2012-7":"0","2012-8":"0","2012-9":"0","2012-10":"0","2012-11":"0","2012-12":"0","2013-1":"0","2013-2":"0","2013-3":"0","2013-4":"0","2013-5":"0","2013-6":"0","2013-7":"0","2013-8":"0","2013-9":"0","2013-10":"0","2013-11":"0","2013-12":"0","2014-1":"0","2014-2":"33","2014-3":"120","2014-4":"257","2014-5":"410","2014-6":"540","2014-7":"683","2014-8":"848"},"total_pending_percentage_difference":{"2012-3":0,"2012-4":0,"2012-5":0,"2012-6":0,"2012-7":0,"2012-8":0,"2012-9":0,"2012-10":0,"2012-11":0,"2012-12":0,"2013-1":0,"2013-2":0,"2013-3":0,"2013-4":0,"2013-5":0,"2013-6":0,"2013-7":0,"2013-8":0,"2013-9":0,"2013-10":0,"2013-11":0,"2013-12":0,"2014-1":0,"2014-2":0,"2014-3":"263.64","2014-4":"114.17","2014-5":"59.53","2014-6":"31.71","2014-7":"26.48","2014-8":0},"total_pending_percentage_difference_first_last":0,"total_pending_percentage_trend_line":{"result":{"2012-2":-139.88306451612905,"2012-3":-124.34032258064516,"2012-4":-108.7975806451613,"2012-5":-93.25483870967743,"2012-6":-77.71209677419355,"2012-7":-62.169354838709694,"2012-8":-46.62661290322582,"2012-9":-31.083870967741944,"2012-10":-15.541129032258084,"2012-11":0.0016129032258049847,"2012-12":15.544354838709666,"2013-1":31.087096774193526,"2013-2":46.629838709677415,"2013-3":62.172580645161275,"2013-4":77.71532258064516,"2013-5":93.25806451612902,"2013-6":108.80080645161291,"2013-7":124.34354838709675,"2013-8":139.88629032258063,"2013-9":155.42903225806452,"2013-10":170.97177419354836,"2013-11":186.51451612903224,"2013-12":202.05725806451613,"2014-1":217.59999999999997,"2014-2":233.14274193548385,"2014-3":248.68548387096774,"2014-4":264.22822580645163,"2014-5":279.77096774193546,"2014-6":295.31370967741935,"2014-7":310.85645161290324,"2014-8":326.3991935483871}},"inventory":{"2012-2":"0","2012-3":"0","2012-4":"0","2012-5":"0","2012-6":"0","2012-7":"0","2012-8":"0","2012-9":"0","2012-10":"0","2012-11":"0","2012-12":"0","2013-1":"0","2013-2":"0","2013-3":"0","2013-4":"0","2013-5":"0","2013-6":"0","2013-7":"0","2013-8":"0","2013-9":"0","2013-10":"0","2013-11":"0","2013-12":"0","2014-1":"0","2014-2":"7","2014-3":"26","2014-4":"49","2014-5":"82","2014-6":"118","2014-7":"149","2014-8":"196"},"inventory_percentage_difference":{"2012-3":0,"2012-4":0,"2012-5":0,"2012-6":0,"2012-7":0,"2012-8":0,"2012-9":0,"2012-10":0,"2012-11":0,"2012-12":0,"2013-1":0,"2013-2":0,"2013-3":0,"2013-4":0,"2013-5":0,"2013-6":0,"2013-7":0,"2013-8":0,"2013-9":0,"2013-10":0,"2013-11":0,"2013-12":0,"2014-1":0,"2014-2":0,"2014-3":"271.43","2014-4":"88.46","2014-5":"67.35","2014-6":"43.90","2014-7":"26.27","2014-8":0},"inventory_percentage_difference_first_last":0,"inventory_percentage_trend_line":{"result":{"2012-2":-30.616935483870968,"2012-3":-27.22741935483871,"2012-4":-23.837903225806453,"2012-5":-20.448387096774194,"2012-6":-17.058870967741935,"2012-7":-13.66935483870968,"2012-8":-10.27983870967742,"2012-9":-6.890322580645162,"2012-10":-3.5008064516129025,"2012-11":-0.11129032258064342,"2012-12":3.2782258064516157,"2013-1":6.667741935483868,"2013-2":10.057258064516127,"2013-3":13.446774193548386,"2013-4":16.836290322580645,"2013-5":20.225806451612904,"2013-6":23.615322580645163,"2013-7":27.004838709677422,"2013-8":30.39435483870968,"2013-9":33.78387096774194,"2013-10":37.1733870967742,"2013-11":40.56290322580646,"2013-12":43.95241935483872,"2014-1":47.34193548387096,"2014-2":50.73145161290322,"2014-3":54.12096774193548,"2014-4":57.51048387096774,"2014-5":60.9,"2014-6":64.28951612903225,"2014-7":67.67903225806452,"2014-8":71.06854838709677}},"most_expensive":[{"id":264350,"source_id":1,"mls_number":"40636648","property_class":"RESIDENTIAL","building_type":"Detached","area":"Fremont","status_category":"Sold","status_detail":"0","status":"Sold","asking_price":5999950,"system_price":5816888,"sold_price":5816888,"status_changed_at":"2014-06-24T07:00:00.000Z","inputted_at":"2013-10-26T10:36:00.000Z","source_updated_at":"2014-06-25T00:33:00.000Z","photos_updated_at":"2013-11-23T08:38:00.000Z","off_market_on":"2014-03-03T00:00:00.000Z","contracted_on":"2014-03-03T00:00:00.000Z","closed_on":"2014-06-24T00:00:00.000Z","address_number":"44555","address_search_number":44555,"address_direction":null,"address_street":"OVERLOOK TER","address2":null,"city":"FREMONT","state":"CA","zip":"94539","zip6":"6218","acres":1.93,"sq_ft":13319,"dom":129,"dom_mls":129,"cdom":129,"cdom_mls":129,"created_at":"2014-03-10T05:50:09.187Z","updated_at":"2014-06-25T00:40:08.523Z","latitude":"37.516764","longitude":"-121.912531","source_photo_count":25,"photo_count":0}],"most_cheapest":[{"id":164106,"source_id":1,"mls_number":"40505165","property_class":"RESIDENTIAL","building_type":"Condo","area":"Fremont","status_category":"Sold","status_detail":"0","status":"Sold","asking_price":99999,"system_price":65000,"sold_price":65000,"status_changed_at":"2011-03-29T07:00:00.000Z","inputted_at":"2011-01-20T08:45:00.000Z","source_updated_at":"2011-03-29T23:36:00.000Z","photos_updated_at":"2011-01-20T09:42:00.000Z","off_market_on":"2011-02-18T00:00:00.000Z","contracted_on":"2011-02-18T00:00:00.000Z","closed_on":"2011-03-24T00:00:00.000Z","address_number":"38627","address_search_number":38627,"address_direction":null,"address_street":"CHERRY LN","address2":"32","city":"FREMONT","state":"CA","zip":"94536","zip6":"4221","acres":14.9,"sq_ft":628,"dom":30,"dom_mls":30,"cdom":30,"cdom_mls":30,"created_at":"2014-01-17T21:47:55.214Z","updated_at":"2014-04-19T11:16:12.952Z","latitude":"37.566012","longitude":"-121.970787","source_photo_count":1,"photo_count":0}],"market_type":"Sellers Market"}}]');
//            buildGraphs(results[0]);
//            spinnerService.stop('main-loading');

            $q.all([
                    Stats.get({
                        'state'        : $scope.state,
                        'city'         : $scope.city,
                        'county'       : $scope.county,
                        'date_from'    : ($scope.inputReportDate && $scope.inputReportDate.from) ? $scope.inputReportDate.from : null,
                        'date_to'      : ($scope.inputReportDate && $scope.inputReportDate.to) ? $scope.inputReportDate.to : null,
                        'building_type': ($scope.inputPropertyType && $scope.inputPropertyType !== 'All') ? $scope.inputPropertyType : null
                    }).$promise
                ]).then(

                // success
                function(results) {

                    spinnerService.stop('main-loading');

                    try {
                        console.log('check for results');
                        console.log(results);
                        console.log(angular.toJson(results));

                        buildGraphs(results[0]);
                    }
                    catch (ex){

                    }
                },

                // error
                function(errors) {
                    spinnerService.stop('main-loading');
                    messageBus.set('error', 'Failed to connect to backend server. Please try again.');
                }
            );

            // format the data to the accepted format
            // $scope.graphData = (data && data.payload && data.payload['Average Sold Price']) ? data.payload['Average Sold Price'] : {};
        }

        // -------------------------------------------
        // Scope Functions
        // -------------------------------------------


        // -------------------------------------------
        // Bootstrap
        // -------------------------------------------

        // watch the property type change
        $scope.$watch(function() {
            return $scope.inputPropertyType;
        }, function() {
            getData();
        });

        // watch the report date change
        $scope.$watch(function() {
            return $scope.inputReportDate;
        }, function() {
            getData();
        });

        // show and hide the report header
        angular.element($window).bind("scroll", function() {
            if(this.pageYOffset >= 10) {
                angular.element('#report-header').hide();
                angular.element('#report-header-tiny').show();
            } else {
                angular.element('#report-header').show();
                angular.element('#report-header-tiny').hide();
                // angular.element('#report-header').css({'opacity': 1, 'box-shadow': 'none'});
            }
        });

        // start the spinner
        spinnerService.start('main-loading');

    }]);